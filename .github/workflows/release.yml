on:
  pull_request:
    types: [ labeled ]
    branches:
      - gh-actions

jobs:
  set-release-type:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - name: Set major release
        if: ${{ github.event.label.name == 'release-major' }}
        run: echo "RELEASE=\"major\"" >> $GITHUB_ENV
      - name: Set minor release
        if: ${{ github.event.label.name == 'release-minor' }}
        run: echo "RELEASE=\"minor\"" >> $GITHUB_ENV
      - name: Set patch release
        if: ${{ github.event.label.name == 'release-patch' }}
        run: echo "RELEASE=\"patch\"" >> $GITHUB_ENV
      - name: Set beta release
        if: ${{ github.event.label.name == 'release-beta' }}
        run: echo "RELEASE=\"prerel beta\"" >> $GITHUB_ENV
      - name: Check release env
        id: check-release-env
        run: |
          if [[ -z ${{ env.RELEASE }} ]];
          then
            echo "You need to set a release label on PRs to the main branch"
            exit 1
          else
            exit 0
          fi
      - name: Install semver-tool
        run: |
          export DIR=$(mktemp -d)
          cd $DIR
          curl https://github.com/fsaintjacques/semver-tool/archive/3.2.0.tar.gz -L -o semver.tar.gz
          tar -xvf semver.tar.gz
          sudo cp semver-tool-3.2.0/src/semver /usr/local/bin
      - name: Set the new version
        run: |
          export CURRENT_VERSION=$(jq -r '.version' package.json)
          export NEW_VERSION=$(semver bump ${{ env.RELEASE }} $CURRENT_VERSION)
          echo "VERSION=$NEW_VERSION" >> $GITHUB_ENV
      - name: Bump version
        uses: actions/setup-node@v2
        with:
          node-version: 16.x
      - run: npm version --git-tag-version=false ${{ env.VERSION }}
      - name: Setup git
        run: |
          git config user.email "pusher-ci@pusher.com"
          git config user.name "Pusher CI"
          git fetch
          git checkout ${{ github.event.pull_request.head.ref }}
      - name: Commit changes
        run: |
          git add package.json
          git commit -m "Bump to version ${{ env.VERSION }}"
      - name: Push
        run: git push